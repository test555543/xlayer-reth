name: Poll PR Trigger Commands

on:
  schedule:
    - cron: '*/2 * * * *'
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: poll-pr-triggers-${{ github.ref }}
  cancel-in-progress: false

env:
  UPSTREAM_REPO: okx/xlayer-reth  # Change this to the repo you want to monitor
  TRIGGER_COMMAND: /trigger

jobs:
  check-pr-comments:
    name: Check PR comments for /trigger
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write  # Need write to update state file
      actions: write   # Need to trigger workflows
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 1

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create state directory if needed
        run: |
          mkdir -p .github/poll-state

      - name: Get last checked timestamp
        id: last_check
        run: |
          STATE_FILE=".github/poll-state/last-pr-comment-check.txt"

          if [ -f "$STATE_FILE" ]; then
            LAST_CHECKED=$(cat "$STATE_FILE")
            echo "Last checked: $LAST_CHECKED"
          else
            # First run - check comments from last 1 hour
            LAST_CHECKED=$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-1H +%Y-%m-%dT%H:%M:%SZ)
            echo "First run - checking since: $LAST_CHECKED"
          fi

          echo "last_checked=$LAST_CHECKED" >> $GITHUB_OUTPUT
          echo "state_file=$STATE_FILE" >> $GITHUB_OUTPUT

      - name: Check for /trigger commands in PR comments
        id: check_triggers
        env:
          GH_TOKEN: ${{ github.token }}
          LAST_CHECKED: ${{ steps.last_check.outputs.last_checked }}
        run: |
          echo "Checking for '$TRIGGER_COMMAND' in open PRs on $UPSTREAM_REPO"
          echo "Looking for comments since: $LAST_CHECKED"
          echo ""

          # Get all open PRs (excluding drafts)
          echo "Fetching open PRs..."
          OPEN_PRS=$(gh pr list \
            --repo "$UPSTREAM_REPO" \
            --state open \
            --json number,title,isDraft,updatedAt \
            --limit 100)

          # Filter out draft PRs
          NON_DRAFT_PRS=$(echo "$OPEN_PRS" | jq '[.[] | select(.isDraft == false)]')
          PR_COUNT=$(echo "$NON_DRAFT_PRS" | jq 'length')

          echo "Found $PR_COUNT open (non-draft) PRs"

          TRIGGERS_FOUND=0
          TRIGGERED_PRS=""

          # Store PR branch info for triggering
          declare -A PR_BRANCHES
          declare -A PR_REPOS
          declare -A PR_SHAS

          # Check each PR for /trigger comments
          for pr_number in $(echo "$NON_DRAFT_PRS" | jq -r '.[].number'); do
            echo "Checking PR #$pr_number..."

            # Get comments for this PR since last check
            COMMENTS=$(gh api \
              "/repos/$UPSTREAM_REPO/issues/$pr_number/comments" \
              --jq ".[] | select(.created_at > \"$LAST_CHECKED\") | {id: .id, body: .body, created_at: .created_at, user: .user.login}")

            if [ -n "$COMMENTS" ]; then
              # Check if any comment contains /trigger
              while IFS= read -r comment; do
                BODY=$(echo "$comment" | jq -r '.body // empty')

                # Check if comment contains /trigger (case-insensitive, allow it anywhere in comment)
                if echo "$BODY" | grep -iq "^${TRIGGER_COMMAND}\s*$\|^${TRIGGER_COMMAND}\s\|${TRIGGER_COMMAND}$"; then
                  COMMENT_ID=$(echo "$comment" | jq -r '.id')
                  COMMENT_USER=$(echo "$comment" | jq -r '.user')
                  COMMENT_DATE=$(echo "$comment" | jq -r '.created_at')

                  echo "‚úÖ Found $TRIGGER_COMMAND in PR #$pr_number"
                  echo "   Comment ID: $COMMENT_ID"
                  echo "   User: $COMMENT_USER"
                  echo "   Date: $COMMENT_DATE"

                  # Get PR details including head branch and SHA
                  PR_INFO=$(gh pr view "$pr_number" --repo "$UPSTREAM_REPO" --json headRefName,headRepository,headRepositoryOwner,headRefOid)
                  PR_BRANCH=$(echo "$PR_INFO" | jq -r '.headRefName')
                  PR_REPO_OWNER=$(echo "$PR_INFO" | jq -r '.headRepositoryOwner.login')
                  PR_REPO_NAME=$(echo "$PR_INFO" | jq -r '.headRepository.name')
                  PR_HEAD_SHA=$(echo "$PR_INFO" | jq -r '.headRefOid')

                  echo "   PR Branch: $PR_BRANCH"
                  echo "   PR Repo: $PR_REPO_OWNER/$PR_REPO_NAME"
                  echo "   PR Head SHA: $PR_HEAD_SHA"

                  # Check if workflow already ran for this commit SHA
                  echo "   Checking for existing workflow runs on this commit..."

                  # Get recent workflow runs for scheduler_xlayer.yml including display_title
                  WORKFLOW_RUNS=$(gh api \
                    "/repos/${{ github.repository }}/actions/workflows/scheduler_xlayer.yml/runs?per_page=50" \
                    --jq '.workflow_runs[] | {id: .id, status: .status, name: .display_title}')

                  RUNS_COUNT=$(echo "$WORKFLOW_RUNS" | grep -c "id" || echo "0")
                  echo "   Found $RUNS_COUNT recent workflow runs to check"

                  FOUND_COMPLETED=false
                  FOUND_ACTIVE=false
                  CHECKED_COUNT=0

                  # Check each workflow run to see if its name contains this PR SHA
                  while IFS= read -r run; do
                    if [ -z "$run" ]; then continue; fi

                    RUN_ID=$(echo "$run" | jq -r '.id')
                    RUN_STATUS=$(echo "$run" | jq -r '.status')
                    RUN_NAME=$(echo "$run" | jq -r '.name // ""')

                    CHECKED_COUNT=$((CHECKED_COUNT + 1))

                    # Show first few runs for debugging
                    if [ $CHECKED_COUNT -le 3 ]; then
                      echo "   [${CHECKED_COUNT}] Run #$RUN_ID: status=$RUN_STATUS, name='$RUN_NAME'"
                    fi

                    # Check if the workflow run name contains the PR SHA
                    # Run name format: "PR CI - {full_sha}" or "Scheduled CI"
                    if [[ "$RUN_NAME" == *"$PR_HEAD_SHA"* ]]; then
                      echo "   ‚úì Match found! Run #$RUN_ID name contains commit SHA"
                      if [ "$RUN_STATUS" = "completed" ]; then
                        FOUND_COMPLETED=true
                        echo "   ‚è≠Ô∏è  Skipping - Workflow already completed for commit ${PR_HEAD_SHA:0:8} (run #$RUN_ID)"
                        break
                      elif [ "$RUN_STATUS" = "in_progress" ] || [ "$RUN_STATUS" = "queued" ] || [ "$RUN_STATUS" = "waiting" ]; then
                        FOUND_ACTIVE=true
                        echo "   ‚è≠Ô∏è  Skipping - Workflow already $RUN_STATUS for commit ${PR_HEAD_SHA:0:8} (run #$RUN_ID)"
                        break
                      fi
                    fi
                  done <<< "$WORKFLOW_RUNS"

                  echo "   Checked $CHECKED_COUNT workflow runs"

                  # Skip triggering if we found an existing run
                  if [ "$FOUND_COMPLETED" = true ] || [ "$FOUND_ACTIVE" = true ]; then
                    continue
                  fi

                  echo "   ‚úì Will trigger CI - No previous run found for commit ${PR_HEAD_SHA:0:8}"

                  TRIGGERS_FOUND=$((TRIGGERS_FOUND + 1))
                  TRIGGERED_PRS="$TRIGGERED_PRS#$pr_number"

                  # Store branch, repo, and SHA info (use first triggered PR if multiple)
                  if [ -z "${PR_BRANCHES[$pr_number]}" ]; then
                    PR_BRANCHES[$pr_number]="$PR_BRANCH"
                    PR_REPOS[$pr_number]="$PR_REPO_OWNER/$PR_REPO_NAME"
                    PR_SHAS[$pr_number]="$PR_HEAD_SHA"
                  fi

                  # Only trigger once even if multiple /trigger comments found
                  break
                fi
              done <<< "$(echo "$COMMENTS" | jq -c '.')"
            fi
          done

          # Export PR branch info for the first triggered PR
          if [ $TRIGGERS_FOUND -gt 0 ]; then
            FIRST_PR=$(echo "$TRIGGERED_PRS" | cut -d'#' -f2 | cut -d' ' -f1)
            echo "pr_branch=${PR_BRANCHES[$FIRST_PR]}" >> $GITHUB_OUTPUT
            echo "pr_repo=${PR_REPOS[$FIRST_PR]}" >> $GITHUB_OUTPUT
            echo "pr_sha=${PR_SHAS[$FIRST_PR]}" >> $GITHUB_OUTPUT
          fi

          echo ""
          echo "Total triggers found: $TRIGGERS_FOUND"

          if [ $TRIGGERS_FOUND -gt 0 ]; then
            echo "trigger_found=true" >> $GITHUB_OUTPUT
            echo "triggered_prs=$TRIGGERED_PRS" >> $GITHUB_OUTPUT
          else
            echo "trigger_found=false" >> $GITHUB_OUTPUT
            echo "No new /trigger commands found"
          fi

      - name: Update timestamp
        if: always()
        run: |
          # Store current timestamp for next check
          CURRENT_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "$CURRENT_TIME" > "${{ steps.last_check.outputs.state_file }}"

          # Commit timestamp file if changed
          if git diff --quiet "${{ steps.last_check.outputs.state_file }}"; then
            echo "No changes to timestamp"
          else
            git add "${{ steps.last_check.outputs.state_file }}"
            git commit -m "Update PR polling timestamp [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
            echo "Updated timestamp: $CURRENT_TIME"
          fi

      - name: Trigger CI workflow
        if: steps.check_triggers.outputs.trigger_found == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üöÄ Preparing to trigger scheduler_xlayer.yml workflow..."
          echo "Triggered by PR(s): ${{ steps.check_triggers.outputs.triggered_prs }}"
          echo "PR Branch: ${{ steps.check_triggers.outputs.pr_branch }}"
          echo "PR Repo: ${{ steps.check_triggers.outputs.pr_repo }}"
          echo "PR SHA: ${{ steps.check_triggers.outputs.pr_sha }}"

          echo ""
          echo "üöÄ Triggering CI workflow..."
          echo "Note: Concurrency group 'pr-ci-${{ steps.check_triggers.outputs.pr_sha }}' prevents duplicate runs on same commit"
          gh workflow run scheduler_xlayer.yml \
            --ref ${{ github.ref_name }} \
            --field triggered_by="pr-comment" \
            --field upstream_sha="" \
            --field pr_numbers="${{ steps.check_triggers.outputs.triggered_prs }}" \
            --field pr_branch="${{ steps.check_triggers.outputs.pr_branch }}" \
            --field pr_repo="${{ steps.check_triggers.outputs.pr_repo }}" \
            --field pr_sha="${{ steps.check_triggers.outputs.pr_sha }}"

          echo "‚úÖ Trigger request sent successfully"

      - name: Summary
        if: always()
        run: |
          echo "## üîç PR Trigger Comment Polling" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream Repository:** https://github.com/$UPSTREAM_REPO" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger Command:** \`$TRIGGER_COMMAND\`" >> $GITHUB_STEP_SUMMARY
          echo "**Checked Since:** ${{ steps.last_check.outputs.last_checked }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.check_triggers.outputs.trigger_found }}" == "true" ]]; then
            echo "‚úÖ **Trigger found!** - CI workflow triggered" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Triggered by PRs:** ${{ steps.check_triggers.outputs.triggered_prs }}" >> $GITHUB_STEP_SUMMARY
            echo "**PR Branch:** ${{ steps.check_triggers.outputs.pr_branch }}" >> $GITHUB_STEP_SUMMARY
            echo "**PR Repository:** ${{ steps.check_triggers.outputs.pr_repo }}" >> $GITHUB_STEP_SUMMARY
            echo "**PR Commit:** ${{ steps.check_triggers.outputs.pr_sha }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ÑπÔ∏è **No triggers found** - No action taken" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Reasons for no triggers:" >> $GITHUB_STEP_SUMMARY
            echo "- No new \`/trigger\` comments found" >> $GITHUB_STEP_SUMMARY
            echo "- OR workflow already running for PR" >> $GITHUB_STEP_SUMMARY
            echo "- OR workflow already completed for current commit" >> $GITHUB_STEP_SUMMARY
          fi
