name: X Layer Scheduled CI

on:
  schedule:
    - cron: '0 15 * * *'
  workflow_dispatch:      # Allow manual trigger

# Ensure only one workflow runs at a time
concurrency:
  group: scheduler-xlayer-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  SEED: rustethereumethereumrust
  RUST_BACKTRACE: 1

jobs:
  ##############################################################################
  # Phase 0: Sync from Upstream
  ##############################################################################

  sync-upstream:
    name: Sync from upstream (okx/reth)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write  # Required for pushing merged changes
      pull-requests: none
      issues: none
      packages: none
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout current branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/okx/xlayer-reth.git || true
          git remote -v

      - name: Fetch upstream
        run: |
          echo "Fetching from upstream okx/xlayer-reth..."
          git fetch upstream main

      - name: Merge upstream/main into current branch
        id: merge
        continue-on-error: true
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "Attempting to merge upstream/main..."

          if git merge --no-edit upstream/main; then
            echo "âœ… Merge successful"
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Merge conflict detected"
            echo "merge_status=conflict" >> $GITHUB_OUTPUT
            git merge --abort
            exit 1
          fi

      - name: Push merged changes
        if: steps.merge.outputs.merge_status == 'success'
        run: |
          echo "Pushing changes to origin..."
          git push origin HEAD:${{ github.ref_name }}

      - name: Generate sync summary
        if: always()
        run: |
          echo "## ðŸ”„ Upstream Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream:** https://github.com/okx/xlayer-reth (main branch)" >> $GITHUB_STEP_SUMMARY
          echo "**Target Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.merge.outputs.merge_status }}" == "success" ]]; then
            echo "âœ… **Successfully synced from upstream**" >> $GITHUB_STEP_SUMMARY

            # Show recent commits from upstream
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Recent Upstream Changes" >> $GITHUB_STEP_SUMMARY
            git log --oneline --graph --decorate -10 >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Merge conflict detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Please resolve conflicts manually:" >> $GITHUB_STEP_SUMMARY
            echo "1. Clone the repository" >> $GITHUB_STEP_SUMMARY
            echo "2. Run: \`git remote add upstream https://github.com/okx/xlayer-reth.git\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Run: \`git fetch upstream\`" >> $GITHUB_STEP_SUMMARY
            echo "4. Run: \`git merge upstream/main\`" >> $GITHUB_STEP_SUMMARY
            echo "5. Resolve conflicts and push" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail workflow if merge conflict
        if: steps.merge.outputs.merge_status != 'success'
        run: |
          echo "::error::Merge conflict detected. Please resolve manually."
          exit 1

  ##############################################################################
  # Phase 1: Check Suite
  ##############################################################################

  basic-checks:
    needs: [sync-upstream]
    name: Basic Checks
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
    strategy:
      fail-fast: true
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Pull latest changes from sync
        run: |
          git pull origin ${{ github.ref_name }}

      - uses: extractions/setup-just@v3
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Run justfile check
        id: run_checks
        continue-on-error: true
        run: |
          just check

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸ§ª Basic Checks " >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.run_checks.outcome }}" == "success" ]; then
            echo "âœ… **All checks passed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some checks failed**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail workflow if checks failed
        if: steps.run_checks.outcome != 'success'
        run: |
          echo "::error::Checks failed. Please review the errors above."
          exit 1

  ##############################################################################
  # Phase 2: Check unused dependencies 
  ##############################################################################

  udeps:
    needs: [sync-upstream]
    name: Unused Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Pull latest changes from sync
        run: |
          git pull origin ${{ github.ref_name }}

      - uses: rui314/setup-mold@725a8794d15fc7563f59595bd9556495c0564878 # v1
      - uses: dtolnay/rust-toolchain@0c3131df9e5407c0c36352032d04af846dbe0fb7 # nightly
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          cache-on-failure: true
          add-rust-environment-hash-key: "false"
          key: nightly-${{ hashFiles('Cargo.lock') }}
      - uses: taiki-e/install-action@3575e532701a5fc614b0c842e4119af4cc5fd16d # v2.62.60
        with:
          tool: cargo-udeps

      - name: Run cargo udeps
        id: run_udeps
        continue-on-error: true
        run: |
          set +e
          cargo +nightly udeps --workspace --all-features --all-targets 2>&1 | tee udeps_output.txt
          exit_code=${PIPESTATUS[0]}
          exit $exit_code

      - name: Generate test summary
        if: always()
        run: |
          echo "## ðŸ” Unused Dependencies Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run_udeps.outcome }}" == "success" ]; then
            echo "âœ… **No unused dependencies found**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Unused dependencies detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ -f udeps_output.txt ]; then
              # Extract only the unused dependencies section (skip build/loading info)
              # Start from "unused dependencies:" line and continue to the end
              if grep -q "unused dependencies:" udeps_output.txt; then
                echo '```' >> $GITHUB_STEP_SUMMARY
                # Use awk to extract from "unused dependencies:" to end, skipping empty leading lines
                awk '/unused dependencies:/{found=1} found' udeps_output.txt | \
                  grep -v "Checking\|Loading depinfo\|Finished\|info:" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
              else
                echo "âš ï¸ Could not parse unused dependencies output" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi

      - name: Fail workflow if udeps failed
        if: steps.run_udeps.outcome != 'success'
        run: |
          echo "::error::Unused dependencies found. Please review the errors above."
          exit 1

  ##############################################################################
  # Phase 3: Summary & Notification
  ##############################################################################

  summary:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs:
      - sync-upstream
      - basic-checks
      - udeps

    if: always()
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Generate comprehensive summary
        run: |
          # Determine overall status first
          if [[ "${{ needs.sync-upstream.result }}" == "success" ]] && \
             [[ "${{ needs.basic-checks.result }}" == "success" ]] && \
             [[ "${{ needs.udeps.result }}" == "success" ]]; then
            OVERALL_STATUS="SUCCESS"
            STATUS_EMOJI="âœ…"
            STATUS_COLOR="ðŸŸ¢"
            echo "all_passed" > status.txt
          else
            OVERALL_STATUS="FAILED"
            STATUS_EMOJI="âŒ"
            STATUS_COLOR="ðŸ”´"
            echo "some_failed" > status.txt
          fi

          echo "# ðŸ“Š X Layer Scheduled CI Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Display overall status prominently at the top
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# ${STATUS_COLOR} Overall Status: ${OVERALL_STATUS} ${STATUS_EMOJI}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ” Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY

          # Upstream Sync
          if [[ "${{ needs.sync-upstream.result }}" == "success" ]]; then
            echo "| Upstream Sync | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Upstream Sync | âŒ Failed (Conflict) |" >> $GITHUB_STEP_SUMMARY
          fi

          # Basic Checks
          if [[ "${{ needs.basic-checks.result }}" == "success" ]]; then
            echo "| Basic Checks | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Basic Checks | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Unused Dependencies Check
          if [[ "${{ needs.udeps.result }}" == "success" ]]; then
            echo "| Unused Dependencies | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unused Dependencies | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "View detailed logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: ci-summary
          path: status.txt
          retention-days: 30


  notify:
    name: Send Lark Notification
    runs-on: ubuntu-latest
    needs: [sync-upstream, basic-checks, udeps, summary]
    if: always()
    timeout-minutes: 10
    permissions:
      contents: none
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Determine Status and Send Notification
        env:
          LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        run: |
          # Determine overall status and color
          if [[ "${{ needs.summary.result }}" == "success" ]]; then
            CARD_COLOR="green"
            STATUS_TEXT="âœ… All Tasks Passed"
            STATUS_EMOJI="âœ…"
          else
            CARD_COLOR="red"
            STATUS_TEXT="âŒ Some Tasks Failed"
            STATUS_EMOJI="âŒ"
          fi

          # Get current time in Beijing timezone
          CURRENT_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          COMMIT_SHORT="${GITHUB_SHA:0:8}"

          # Build status for each check
          get_status_icon() {
            if [[ "$1" == "success" ]]; then
              echo "âœ…"
            else
              echo "âŒ"
            fi
          }

          SYNC_ICON=$(get_status_icon "${{ needs.sync-upstream.result }}")
          UNIT_ICON=$(get_status_icon "${{ needs.basic-checks.result }}")
          UDEPS_ICON=$(get_status_icon "${{ needs.udeps.result }}")

          # Build Lark Card JSON
          cat > lark_card.json <<EOF
          {
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "${STATUS_EMOJI} X-Layer Reth (new framework) Scheduled CI Report"
                },
                "template": "${CARD_COLOR}"
              },
              "elements": [
                {
                  "tag": "div",
                  "fields": [
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**ðŸ“… Run Time**\\n${CURRENT_TIME}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**ðŸ”€ Branch**\\n${{ github.ref_name }}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**ðŸ“ Commit**\\n${COMMIT_SHORT}"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "**ðŸ”¢ Run ID**\\n${{ github.run_id }}"
                      }
                    }
                  ]
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "**ðŸ§ª Test Status**"
                  }
                },
                {
                  "tag": "div",
                  "fields": [
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "${SYNC_ICON} Upstream Sync"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "${UNIT_ICON} Basic Checks"
                      }
                    },
                    {
                      "is_short": true,
                      "text": {
                        "tag": "lark_md",
                        "content": "${UDEPS_ICON} Unused Dependencies"
                      }
                    }
                  ]
                },
                {
                  "tag": "hr"
                },
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "**${STATUS_TEXT}**"
                  }
                },
                {
                  "tag": "action",
                  "actions": [
                    {
                      "tag": "button",
                      "text": {
                        "tag": "plain_text",
                        "content": "View Detailed Logs"
                      },
                      "type": "primary",
                      "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
          }
          EOF

          # Send to Lark/Feishu
          if [ -n "$LARK_WEBHOOK_URL" ]; then
            echo "Sending card notification to Lark..."

            # Send request and capture response (webhook URL never logged)
            response=$(curl -s -w "\n%{http_code}" -X POST "$LARK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              -d @lark_card.json)

            http_code=$(echo "$response" | tail -n1)
            response_body=$(echo "$response" | head -n-1)

            if [ "$http_code" -eq 200 ]; then
              echo "âœ… Lark notification sent successfully"
              # Only log sanitized response (no sensitive data)
              echo "$response_body" | jq -r '.msg // "OK"' || echo "Notification delivered"
            else
              echo "âŒ Failed to send Lark notification"
              echo "HTTP Status Code: $http_code"
              # Log sanitized error only (no webhook URL exposure)
              echo "$response_body" | jq -r '.msg // .error // "Unknown error"' || echo "Check webhook configuration"
            fi
          else
            echo "âš ï¸ LARK_WEBHOOK_URL not configured. Skipping notification."
            echo ""
            echo "To enable Lark notifications:"
            echo "1. Go to GitHub repository Settings â†’ Secrets â†’ Actions"
            echo "2. Add a new secret named 'LARK_WEBHOOK_URL'"
            echo "3. Paste your Lark webhook URL as the value"
            echo ""
            echo "Generated card preview:"
            cat lark_card.json | jq '.'
          fi
